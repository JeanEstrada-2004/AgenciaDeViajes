@model AgenciaDeViajes.Models.TourDetailsViewModel
@{
    ViewBag.Title = Model.Destino.nom_destino + " - Detalle del Tour";
    Layout = "_Layout";

    // Armar la URL del ícono aquí (solo si Clima no es null)
    var iconUrl = Model.Clima != null
        ? $"https://openweathermap.org/img/wn/{Model.Clima.Icon}@2x.png"
        : "";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    .addons-infotours {
        border: 1px solid #113d48;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        background: #fafdff;
    }
    .addons-infotours i {
        box-shadow: 0px -4px 30px rgba(0, 0, 0, 0.07);
        background: #4140ca;
        color: #fff;
        padding: 10px;
        border-radius: 10px;
        width: 40px;
        height: 40px;
        text-align: center;
        margin-bottom: .7rem;
    }
    .addons-infotours h5 {
        font-size: 1.05rem;
        margin-bottom: .3rem;
        color: #274169;
    }
    .addons-aditional {
        background-color: #efeefa;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0px -4px 30px rgba(0, 0, 0, 0.07);
        margin-bottom: 2rem;
    }
    .addons-clima {
        background: #4d40ca;
        color: #fff;
        border-radius: 15px;
        margin-bottom: 1.3rem;
        padding: 1rem 1.5rem;
    }
    .addons-pay {
        background: #fefefe;
        color: #000;
        border-radius: 15px;
        box-shadow: 0px -4px 30px rgba(0, 0, 0, 0.07);
        padding: 40px;
        border: 1px solid #eee;
    }

    /* --- REVIEW ELEGANTE --- */
    .review-section-elegant {
        background: #113d48;
        border-radius: 1.2rem;
        box-shadow: 0 4px 24px 0 rgba(17,61,72,0.10);
        padding: 2.5rem 2rem;
        color: #fff;
        margin-bottom: 3rem;
        margin-top: 2rem;
    }
    .review-form-elegant {
        margin-bottom: 2.5rem;
        border-bottom: 1px solid #23435e;
        padding-bottom: 2.2rem;
    }
    .rating-label {
        font-weight: 700;
        margin-bottom: .5rem;
        letter-spacing: .5px;
    }
    .rating-stars {
        font-size: 1.7rem;
        color: #d9d9d9;
        cursor: pointer;
        transition: color .2s;
        margin-bottom: 1.2rem;
    }
    .rating-stars i.active {
        color: #ffc107;
    }
    .form-label {
        color: #bfc8ea;
        font-weight: 600;
    }
    .review-form-elegant textarea {
        border-radius: .7rem;
        border: none;
        padding: 1.1rem;
        resize: none;
        font-size: 1rem;
        min-height: 80px;
    }
    .btn-review {
        padding: .7rem 2.2rem;
        border-radius: 1.7rem;
        font-weight: 700;
        letter-spacing: .7px;
        background: #3284f5;
        border: none;
        transition: background .15s;
    }
    .btn-review:hover {
        background: #2651b9;
    }
    .review-list-elegant {
        margin-top: 2.5rem;
    }
    .review-row {
        display: flex;
        align-items: stretch;
        border-radius: .8rem;
        background: #fff;
        color: #2c2e3a;
        margin-bottom: 1.7rem;
        box-shadow: 0 4px 16px 0 rgba(17,61,72,0.07);
        padding: 1.7rem 1.2rem;
        gap: 1.3rem;
        flex-wrap: wrap;
    }
    .review-col {
        flex: 1 1 33%;
        min-width: 230px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
    }
    .review-name {
        font-weight: 700;
        color: #144d99;
        font-size: 1.09rem;
    }
    .review-stars-static i {
        color: #ffc107;
        font-size: 1.3rem;
        margin-right: .07rem;
    }
    .review-comment {
        font-size: 1.07rem;
        color: #23303e;
        background: #f8fafb;
        border-radius: .6rem;
        padding: 1rem 1.2rem;
        margin-bottom: 0;
        min-height: 55px;
    }
    .review-ia-happy, .review-ia-sad {
        display: flex;
        align-items: center;
        gap: .7rem;
        font-weight: 600;
        font-size: 1rem;
        padding: .8rem 1.1rem;
        border-radius: 1.2rem;
    }
    .review-ia-happy {
        background: #eaffef;
        color: #14b88f;
    }
    .review-ia-sad {
        background: #fff5e4;
        color: #b88f14;
    }
    .review-ia-happy i, .review-ia-sad i {
        font-size: 1.8rem;
    }
    @@media (max-width: 992px) {
        .review-row { flex-direction: column; }
    }
</style>

<section class="ftco-section">
    <div class="container">

        <!-- Portada e info principal -->
        <div class="row justify-content-center">
            <div class="col-md-12">
                <img src="@Model.Destino.ImgDest_url" class="img-fluid rounded mb-4" alt="@Model.Destino.nom_destino" style="width:100%;max-height:500px;object-fit:cover;" />
                <h2 class="mb-3">Destino: @Model.Destino.nom_destino</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">

                <div class="addons-infotours mb-4 p-3">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <i class="bi bi-geo-alt-fill"></i>
                            <h5>Ubicación</h5>
                            @Model.Destino.id_region
                        </div>
                        <div class="col-md-3">
                            <i class="bi bi-clock-fill"></i>
                            <h5>Duración</h5>
                            @Model.Destino.time_tour
                        </div>
                        <div class="col-md-3">
                            <i class="bi bi-ticket-perforated-fill"></i>
                            <h5>Entradas</h5>
                            @Model.Destino.num_entradas
                        </div>
                        <div class="col-md-3">
                            <i class="bi bi-person-walking"></i>
                            <h5>Dificultad</h5>
                            Moderada
                        </div>
                    </div>
                </div>

                <div class="addons-description mb-4">
                    <h4 class="mb-3">Descripción</h4>
                    <p>@Model.Destino.desc_destino</p>
                </div>

                <div class="addons-aditional mb-4">
                    <h4 class="mb-2">Información de viaje</h4>
                    <p>Consulta horarios, recomendaciones y más detalles sobre este destino con nuestros asesores.</p>
                </div>

                <!-- --- REVIEW ELEGANTE --- -->
                <div class="review-section-elegant">
                    <!-- Formulario -->
                    <form id="reviewForm" class="review-form-elegant" method="post">
                        @Html.AntiForgeryToken()
                        <h4 class="mb-4 text-center">¿Cómo fue tu experiencia?</h4>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="rating-label">Atención al Cliente</div>
                                <div class="rating-stars" data-criteria="atencion">
                                    <i class="bi bi-star" data-value="1"></i>
                                    <i class="bi bi-star" data-value="2"></i>
                                    <i class="bi bi-star" data-value="3"></i>
                                    <i class="bi bi-star" data-value="4"></i>
                                    <i class="bi bi-star" data-value="5"></i>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="rating-label">Calidad del Servicio</div>
                                <div class="rating-stars" data-criteria="calidad">
                                    <i class="bi bi-star" data-value="1"></i>
                                    <i class="bi bi-star" data-value="2"></i>
                                    <i class="bi bi-star" data-value="3"></i>
                                    <i class="bi bi-star" data-value="4"></i>
                                    <i class="bi bi-star" data-value="5"></i>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="rating-label">Puntualidad</div>
                                <div class="rating-stars" data-criteria="puntualidad">
                                    <i class="bi bi-star" data-value="1"></i>
                                    <i class="bi bi-star" data-value="2"></i>
                                    <i class="bi bi-star" data-value="3"></i>
                                    <i class="bi bi-star" data-value="4"></i>
                                    <i class="bi bi-star" data-value="5"></i>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4 mt-3">
                            <label for="comentario" class="form-label">Comentario adicional</label>
                            <textarea class="form-control" id="comentario" rows="4" placeholder="Cuéntanos más sobre tu experiencia..."></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-review">Enviar Calificación</button>
                        </div>
                    </form>

                    <!-- Listado de reviews -->
                    <div id="reviews-container" class="review-list-elegant mt-4">
                        @await Component.InvokeAsync("ReviewList", new { destinoId = Model.Destino.id_destino })
                    </div>
                </div>

            </div>

            <div class="col-md-4">
                <div class="bg-light p-4 rounded mb-4">
                    <ul class="list-group mb-3">
                        <li class="list-group-item"><strong>Precio del tour:</strong> S/. @Model.Destino.precio_tour.ToString("0.00")</li>
                    </ul>
                </div>

                <div class="card shadow p-4 mb-4">
                    <h5 class="mb-3 text-primary">Reserva tu experiencia</h5>
                    <form asp-controller="CarritoCompra" asp-action="IniciarReserva" method="post">
                        <input type="hidden" name="DestinoId" value="@Model.Destino.id_destino" />
                        <input type="hidden" name="DestinoNombre" value="@Model.Destino.nom_destino" />
                        <input type="hidden" name="DestinoImagenUrl" value="@Model.Destino.ImgDest_url" />
                        <input type="hidden" name="DestinoDuracion" value="@Model.Destino.time_tour" />
                        <input type="hidden" name="PrecioTour" value="@Model.Destino.precio_tour" />
                        <div class="mb-3">
                            <label for="fechaTour" class="form-label">Fecha del tour</label>
                            <input type="date" class="form-control" id="fechaTour" name="FechaElegida" min="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="adultos" class="form-label">Adultos</label>
                                <input type="number" class="form-control" id="adultos" name="CantidadAdultos" value="1" min="1" max="20" required />
                            </div>
                            <div class="col">
                                <label for="ninos" class="form-label">Niños</label>
                                <input type="number" class="form-control" id="ninos" name="CantidadNinos" value="0" min="0" max="20" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Servicios adicionales</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="ServiciosAdicionales" value="Recojo del hospedaje" id="servRecojo" />
                                <label class="form-check-label" for="servRecojo">Recojo del hospedaje</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="ServiciosAdicionales" value="Desayuno incluido" id="servDesayuno" />
                                <label class="form-check-label" for="servDesayuno">Desayuno incluido</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="ServiciosAdicionales" value="Guía bilingüe" id="servGuia" />
                                <label class="form-check-label" for="servGuia">Guía bilingüe</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Añadir al carrito</button>
                    </form>
                </div>

                <!-- CLIMA ACTUAL -->
                <div class="addons-clima">
                    @if (Model.Clima != null)
                    {
                        <div class="alert  d-flex align-items-center mb-4">
                            <img src="@iconUrl" alt="Clima" style="width:50px;height:50px;margin-right:10px;" />
                            <div>
                                <strong>Clima actual en @Model.Clima.City:</strong><br />
                                @Model.Clima.Description, @Model.Clima.Temperature &deg;C
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-4">No se pudo obtener el clima de la región.</div>
                    }
                </div>
                <!-- FIN CLIMA -->

                <div class="addons-pay">
                    <h4>Medios de pago</h4>
                    <img src="https://arequipaturismo.com/cloud/pay-mercadopago.png" style="max-width: 160px;" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 ftco-animate">
                <a asp-action="Destination" class="btn btn-secondary mt-2">Volver a la lista</a>
            </div>
        </div>
    </div>
</section>

<script>
    // Variables para almacenar el rating seleccionado por cada criterio
    const ratings = {
        atencion: 0,
        calidad: 0,
        puntualidad: 0
    };

    // Manejar clic en estrellas
    document.querySelectorAll('.rating-stars').forEach(group => {
        const criteria = group.dataset.criteria;
        const stars = group.querySelectorAll('i');
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                ratings[criteria] = index + 1;
                stars.forEach((s, i) => {
                    s.classList.toggle('active', i <= index);
                });
            });
        });
    });

    // Manejar envío del formulario por AJAX
    document.getElementById('reviewForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // Validar que todos los criterios estén calificados
        if (ratings.atencion === 0 || ratings.calidad === 0 || ratings.puntualidad === 0) {
            alert('Por favor, califica todos los criterios.');
            return;
        }

        // Validar comentario
        const comentario = document.getElementById('comentario').value.trim();
        if (!comentario) {
            alert('Por favor, escribe un comentario.');
            return;
        }

        // Preparar datos para enviar
        const data = new URLSearchParams();
        data.append('destinoId', '@Model.Destino.id_destino');
        data.append('atencion', ratings.atencion);
        data.append('calidad', ratings.calidad);
        data.append('puntualidad', ratings.puntualidad);
        data.append('comentario', comentario);

        // Token antifalsificación
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        // Enviar POST AJAX
        fetch('@Url.Action("CrearReview", "Review")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': token
            },
            body: data.toString()
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);

                    // Limpiar formulario
                    this.reset();
                    document.querySelectorAll('.rating-stars i').forEach(star => star.classList.remove('active'));

                    // Limpiar ratings
                    ratings.atencion = 0;
                    ratings.calidad = 0;
                    ratings.puntualidad = 0;

                    // Recargar lista reviews
                    recargarReviews();
                } else {
                    alert(result.message);
                }
            })
            .catch(() => alert('Error al enviar la calificación.'));

        // Función para recargar lista de reviews
        function recargarReviews() {
            fetch('@Url.Action("ListarPorDestino", "Review", new { destinoId = Model.Destino.id_destino })')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('reviews-container').innerHTML = html;
                });
        }
    });
</script>
